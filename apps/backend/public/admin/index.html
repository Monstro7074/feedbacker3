<!-- apps/backend/public/admin/index.html -->
<!doctype html>
<html lang="ru">
<head>
  <link rel="stylesheet" href="/admin/admin.css">
  <meta charset="utf-8" />
  <title>Feedbacker Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system;max-width:1000px;margin:24px auto;padding:0 12px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    td,th{border:1px solid #ddd;padding:8px}
    tr:nth-child(even){background:#fafafa}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#eee;font-size:12px;margin-right:4px}
    input,select,button{padding:8px;border:1px solid #ccc;border-radius:8px}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin-top:12px}
    .right{margin-left:auto}
    .muted{color:#6b7280}
    audio{width:100%;margin-top:10px}
  </style>
</head>
<body>
<header>
  <h1>Админка — Feedbacker</h1>
  <div class="row">
    <label>Bearer токен: <input id="token" placeholder="ADMIN_TOKEN"/></label>
    <button id="saveToken">Сохранить</button>
    <button id="logout">Выйти</button>
  </div>
</header>

<section class="card">
  <h3>Настройки</h3>
  <div class="row">
    <label>TELEGRAM_ALERT_THRESHOLD:
      <input id="thr" type="number" step="0.01" min="0" max="1" style="width:100px"/>
    </label>
    <button id="saveThr">Сохранить</button>
    <span class="muted">0..1 — ниже → чувствительнее алерты</span>
  </div>
</section>

<section class="card">
  <h3>Фильтры</h3>
  <div class="row">
    <label>Магазин: <input id="shop" placeholder="shop_001"/></label>
    <label>Сентимент:
      <select id="sent">
        <option value="">(любой)</option>
        <option>негатив</option>
        <option>нейтральный</option>
        <option>позитивный</option>
      </select>
    </label>
    <label>Лимит: <input id="limit" type="number" value="20" min="1" max="100" style="width:80px"/></label>
    <button id="load">Загрузить</button>
    <button id="more" disabled>Ещё</button>
    <button id="btn-export">Экспорт CSV</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th>Время</th><th>Магазин</th><th>Устройство</th>
        <th>Сентимент</th><th>Эмо-скор</th><th>Теги</th><th>Действия</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <audio id="player" controls preload="none"></audio>
</section>

<script>
const $ = sel => document.querySelector(sel);

// --- auth header expected by adminAuth() ---
const api = (path, opts={}) => {
  const token = localStorage.getItem('adm_token') || '';
  return fetch(path, {
    ...opts,
    headers: {
      ...(opts.headers || {}),
      ...(token ? { 'X-Admin-Token': token } : {})
    }
  });
};

// --- token ui ---
$('#token').value = localStorage.getItem('adm_token') || '';
$('#saveToken').onclick = () => {
  localStorage.setItem('adm_token', $('#token').value.trim());
  alert('Токен сохранён');
};
$('#logout').onclick = () => {
  localStorage.removeItem('adm_token');
  $('#token').value = '';
  alert('Вы вышли');
};

// --- settings ---
async function loadSettings() {
  const r = await api('/admin/api/settings');
  if (!r.ok) { alert('Ошибка загрузки настроек'); return; }
  const js = await r.json();
  $('#thr').value = js.TELEGRAM_ALERT_THRESHOLD ?? 0.4;
}
$('#saveThr').onclick = async () => {
  const v = Number($('#thr').value);
  if (!Number.isFinite(v) || v < 0 || v > 1) return alert('0..1');
  const r = await api('/admin/api/settings', {
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    // backend принимает и число, и { value }
    body: JSON.stringify({ TELEGRAM_ALERT_THRESHOLD: v })
  });
  alert(r.ok ? 'Сохранено' : 'Ошибка сохранения');
};

// --- list + pagination ---
let nextOffset = 0;

async function fetchPage({ reset=false } = {}) {
  if (reset) nextOffset = 0;

  const params = new URLSearchParams();
  const shop = $('#shop').value.trim();
  const sent = $('#sent').value.trim();
  const limit = $('#limit').value;
  if (shop) params.set('shop_id', shop);
  if (sent) params.set('sentiment', sent);
  params.set('limit', limit);
  params.set('offset', nextOffset);

  const r = await api('/admin/api/feedbacks?' + params.toString());
  if (!r.ok) { alert('Ошибка загрузки'); return; }
  const js = await r.json();

  const tb = $('#tbl tbody');
  if (reset) tb.innerHTML = '';

  (js.items || []).forEach(it => {
    const tr = document.createElement('tr');
    const tags = (it.tags || []).map(t=>`<span class="badge">${t}</span>`).join(' ');
    tr.innerHTML = `
      <td>${new Date(it.timestamp).toLocaleString()}</td>
      <td>${it.shop_id || ''}</td>
      <td>${it.device_id || ''}</td>
      <td>${it.sentiment}</td>
      <td>${it.emotion_score ?? ''}</td>
      <td>${tags}</td>
      <td>
        <button class="play" data-id="${it.id}">Прослушать</button>
        <a target="_blank" href="/feedback/full/${it.id}">Детали</a>
      </td>`;
    tb.appendChild(tr);
  });

  nextOffset = js.nextOffset ?? null;
  $('#more').disabled = nextOffset == null;
}

$('#load').onclick = () => fetchPage({ reset:true });
$('#more').onclick = () => fetchPage({ reset:false });

// делегирование: кнопка «Прослушать» → безопасный redirect URL
document.addEventListener('click', (e) => {
  const btn = e.target.closest('button.play');
  if (!btn) return;
  const id = btn.dataset.id;
  const player = $('#player');
  player.src = `/feedback/redirect-audio/${id}`;
  player.play().catch(()=>{});
});

// init
loadSettings();
</script>
  <!-- Карточка отзыва (модалка) -->
<div id="modal" class="modal hidden">
  <div class="modal__dialog">
    <button id="modal-close" class="modal__close" aria-label="Закрыть">×</button>
    <h3>Карточка отзыва</h3>

    <div class="grid">
      <div><b>Время:</b> <span id="c-time"></span></div>
      <div><b>Магазин:</b> <span id="c-shop"></span></div>
      <div><b>Устройство:</b> <span id="c-device"></span></div>
      <div><b>Сентимент:</b> <span id="c-sentiment"></span></div>
      <div><b>Эмо-скор:</b> <span id="c-score"></span></div>
      <div><b>Теги (авто):</b> <span id="c-tags"></span></div>
    </div>

    <div style="margin:8px 0;">
      <audio id="c-audio" controls style="width:100%"></audio>
    </div>

    <div><b>Кратко:</b> <div id="c-summary" class="box"></div></div>
    <div><b>Расшифровка:</b> <div id="c-transcript" class="box transcript"></div></div>

    <div style="margin-top:10px">
      <b>Быстрые теги:</b>
      <div id="qtags" class="qtags">
        <button class="qt" data-tag="качество">качество</button>
        <button class="qt" data-tag="размер">размер</button>
        <button class="qt" data-tag="посадка">посадка</button>
        <button class="qt" data-tag="доставка">доставка</button>
        <button class="qt" data-tag="персонал">персонал</button>
        <button class="qt" data-tag="цена">цена</button>
      </div>
    </div>

    <div style="margin-top:8px">
      <b>Заметка менеджера:</b>
      <textarea id="c-note" rows="3" class="box" placeholder="Короткий комментарий"></textarea>
    </div>

    <div style="margin-top:10px; display:flex; gap:8px;">
      <button id="btn-save-anno">Сохранить</button>
      <a id="c-details-link" target="_blank" rel="noopener">Детальная JSON</a>
    </div>
  </div>
</div>

<!-- Тосты -->
<div id="toast" class="toast"></div>

<audio id="player" controls style="width: 100%; margin-top: 12px;"></audio>

</body>
</html>
